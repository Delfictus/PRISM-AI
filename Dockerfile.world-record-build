# World Record - Build in Container for GLIBC compatibility
FROM nvidia/cuda:12.6.2-devel-ubuntu22.04 AS builder

ENV DEBIAN_FRONTEND=noninteractive
ENV CUDA_HOME=/usr/local/cuda
ENV PATH=${CUDA_HOME}/bin:${PATH}
ENV LD_LIBRARY_PATH=${CUDA_HOME}/lib64:${LD_LIBRARY_PATH}
ENV CUDA_COMPUTE_CAP=90

# Install build dependencies
RUN apt-get update && apt-get install -y \
    build-essential \
    curl \
    pkg-config \
    libssl-dev \
    libopenblas-dev \
    gfortran \
    && rm -rf /var/lib/apt/lists/*

# Install Rust
RUN curl --proto '=https' --tlsv1.2 -sSf https://sh.rustup.rs | sh -s -- -y
ENV PATH="/root/.cargo/bin:${PATH}"

WORKDIR /prism-ai

# Copy source
COPY . .

# Build the world record binary IN the container
RUN cargo build --release --features cuda --example world_record_8gpu

# Runtime stage
FROM nvidia/cuda:12.6.2-runtime-ubuntu22.04

ENV DEBIAN_FRONTEND=noninteractive
ENV CUDA_HOME=/usr/local/cuda
ENV PATH=${CUDA_HOME}/bin:${PATH}
ENV LD_LIBRARY_PATH=${CUDA_HOME}/lib64:${LD_LIBRARY_PATH}

RUN apt-get update && apt-get install -y \
    libgomp1 \
    libopenblas0 \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

WORKDIR /prism-ai

# Copy from builder
COPY --from=builder /prism-ai/target/release/examples/world_record_8gpu /usr/local/bin/world_record
COPY --from=builder /prism-ai/target/ptx/*.ptx /prism-ai/target/ptx/
COPY benchmarks/dimacs_official/DSJC1000-5.mtx /prism-ai/benchmarks/dimacs_official/DSJC1000-5.mtx

RUN chmod +x /usr/local/bin/world_record && mkdir -p /output

RUN cat > /entrypoint.sh << 'EOF'
#!/bin/bash
set -e

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘  ðŸ† DSJC1000-5 WORLD RECORD ATTEMPT                         â•‘"
echo "â•‘  8Ã— H200 SXM - 800,000 Attempts                             â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

NUM_GPUS="${NUM_GPUS:-8}"
ATTEMPTS_PER_GPU="${ATTEMPTS_PER_GPU:-100000}"

echo "Configuration:"
echo "  GPUs:             $NUM_GPUS"
echo "  Attempts/GPU:     $ATTEMPTS_PER_GPU"
echo "  Total:            $((NUM_GPUS * ATTEMPTS_PER_GPU))"
echo "  Target:           < 82 colors (world record)"
echo ""

cd /prism-ai
exec /usr/local/bin/world_record 2>&1 | tee /output/world_record_attempt.log
EOF

RUN chmod +x /entrypoint.sh

ENV RUST_BACKTRACE=1
ENV RUST_LOG=info
ENV NUM_GPUS=8
ENV ATTEMPTS_PER_GPU=100000

VOLUME ["/output"]
ENTRYPOINT ["/entrypoint.sh"]
