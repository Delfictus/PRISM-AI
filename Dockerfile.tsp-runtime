# Runtime-only Dockerfile for PRISM-AI TSP H100 Benchmark
# Uses pre-built binary for fast deployment

FROM nvidia/cuda:12.3.1-runtime-ubuntu22.04

# Prevent interactive prompts
ENV DEBIAN_FRONTEND=noninteractive

# CUDA environment
ENV CUDA_HOME=/usr/local/cuda
ENV PATH=${CUDA_HOME}/bin:${PATH}
ENV LD_LIBRARY_PATH=${CUDA_HOME}/lib64:/usr/lib/wsl/lib:${LD_LIBRARY_PATH}

# Install minimal runtime dependencies
RUN apt-get update && apt-get install -y \
    libgomp1 \
    libopenblas0 \
    ca-certificates \
    && rm -rf /var/lib/apt/lists/*

# Create app directory
WORKDIR /prism-ai

# Copy pre-built binary
COPY target/release/examples/honest_tsp_benchmark /usr/local/bin/tsp_benchmark
RUN chmod +x /usr/local/bin/tsp_benchmark

# Copy benchmark data
COPY benchmarks/tsp/pla85900.tsp /prism-ai/benchmarks/tsp/pla85900.tsp

# Copy CUDA PTX files (required for GPU kernels)
COPY target/ptx/*.ptx /prism-ai/target/ptx/

# Create output directory
RUN mkdir -p /output

# Create entrypoint script
RUN cat > /entrypoint.sh << 'EOF'
#!/bin/bash
set -e

echo "â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—"
echo "â•‘  PRISM-AI TSP H100 Benchmark Runner                         â•‘"
echo "â•‘  Target: pla85900 (85,900 cities)                           â•‘"
echo "â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Check GPU
echo "ðŸ” Checking GPU..."
if command -v nvidia-smi &> /dev/null; then
    nvidia-smi --query-gpu=name,driver_version,memory.total --format=csv,noheader
    echo ""
else
    echo "âš ï¸  nvidia-smi not available (GPU detection at runtime)"
    echo ""
fi

# Default parameters
TSP_FILE="${TSP_FILE:-/prism-ai/benchmarks/tsp/pla85900.tsp}"
NUM_CITIES="${NUM_CITIES:-1000}"

echo "ðŸ“‹ Configuration:"
echo "  TSP file:       $TSP_FILE"
echo "  Cities to use:  $NUM_CITIES (of 85,900 total)"
echo ""

echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo "  EXECUTING TSP BENCHMARK"
echo "â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•"
echo ""

# Run benchmark
cd /prism-ai
exec /usr/local/bin/tsp_benchmark "$TSP_FILE" 2>&1 | tee /output/benchmark.log
EOF

RUN chmod +x /entrypoint.sh

# Environment variables for runtime
ENV RUST_BACKTRACE=1
ENV RUST_LOG=info
ENV TSP_FILE=/prism-ai/benchmarks/tsp/pla85900.tsp
ENV NUM_CITIES=1000

# Labels for Docker Hub
LABEL org.opencontainers.image.title="PRISM-AI TSP H100 Runtime"
LABEL org.opencontainers.image.description="GPU-accelerated TSP solver for pla85900 (85,900 cities) on H100 - Runtime only"
LABEL org.opencontainers.image.version="1.0.0"
LABEL org.opencontainers.image.authors="PRISM-AI"
LABEL ai.prism.gpu.target="H100"
LABEL ai.prism.cuda="12.3"
LABEL ai.prism.benchmark="pla85900"
LABEL ai.prism.benchmark.cities="85900"

# Volume for output
VOLUME ["/output"]

# Entrypoint
ENTRYPOINT ["/entrypoint.sh"]
